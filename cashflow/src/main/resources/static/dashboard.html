<!DOCTYPE html
        <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>

    <title>CashFlow - Personal Finance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <style>
        :root {
          --bg: #f1f5f9;
          --card-bg: #ffffff;
          --text: #334155;
          --text-light: #64748b;
          --border: #e2e8f0;
          --shadow: rgba(0, 0, 0, 0.06);
          --primary: #4361ee;
          --success: #10b981;
          --danger: #f72585
        }

        [data-theme="dark"] {
          --bg: #0f172a;
          --card-bg: #1e293b;
          --text: #e2e8f0;
          --text-light: #94a3b8;
          --border: #334155;
          --shadow: rgba(0, 0, 0, 0.3);
          --primary: #818cf8;
          --success: #34d399;
          --danger: #f87171
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); transition: all .3s; min-height: 100vh; }

        .menu-toggle { position: fixed; top: 20px; left: 20px; z-index: 1100; background: var(--card-bg); width: 50px; height: 50px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 15px; color: var(--text); box-shadow: 0 4px 15px var(--shadow); cursor: pointer; }
        .sidebar { width: 260px; background: var(--card-bg); position: fixed; height: 100%; left: 0; top: 0; z-index: 1000; box-shadow: 2px 0 10px var(--shadow); border-right: 1px solid var(--border); transition: transform .3s ease; }
        .sidebar-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--border); }
        .sidebar-header h2 { color: var(--primary); font-size: 26px; font-weight: 700; }

        .menu-item { padding: 16px 24px; display: flex; align-items: center; gap: 14px; cursor: pointer; transition: .3s; border-left: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background: rgba(67, 97, 238, 0.1); color: var(--primary); border-left-color: var(--primary); }

        .logout-btn { position: absolute; bottom: 30px; left: 20px; right: 20px; background: var(--danger); color: white; padding: 14px; border-radius: 12px; text-align: center; cursor: pointer; }

        .main { margin-left: 260px; padding: 30px; transition: margin-left .3s ease; }
        .header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 28px; font-weight: 700; color: var(--text); }

        .theme-toggle { background: var(--card-bg); color: var(--text-light); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; box-shadow: 0 4px 15px var(--shadow); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border); }
        .card-title { font-size: 14px; color: var(--text-light); margin-bottom: 8px; }
        .card-value { font-size: 32px; font-weight: 700; color: var(--text); }

        .charts-row { display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 30px; }
        @media(min-width:768px) { .charts-row { grid-template-columns: 1fr 1fr; } }

        .chart-box, .full-chart { background: var(--card-bg); padding: 50px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border); height: 340px; }
        .full-chart { height: 380px; }
        .chart-title { font-size: 17px; font-weight: 600; margin-bottom: 12px; color: var(--text); }

        canvas { max-height: 100% !important; width: 100% !important; }

        input, select { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; background: var(--card-bg); color: var(--text); font-size: 16px; }
        .btn { background: var(--primary); color: white; padding: 14px 24px; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px; }
        .btn-danger { background: var(--danger); color: white; padding: 10px 16px; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; }

        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px var(--shadow); }

        @media(max-width:992px) {
          .menu-toggle { display: flex !important; }
          .sidebar { transform: translateX(-100%); }
          .sidebar.active { transform: translateX(0); }
          .main { margin-left: 0 !important; padding: 80px 20px 20px; }
        }
        @media(max-width:480px) { .header h1 { font-size: 24px; } .chart-box, .full-chart { height: 300px; } }
        .hidden { display: none; }

        /* BEAUTIFUL CENTERED TOAST */
        #successToast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 20, 35, 0.96);
            color: white;
            padding: 22px 44px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            font-size: 18px;
            font-weight: 600;
            z-index: 9999;
            backdrop-filter: blur(14px);
            border: 1px solid rgba(100, 100, 255, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 14px;
            min-width: 320px;
            justify-content: center;
            text-align: center;
        }

        #successToast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1.05);
            animation: toastPop 0.6s ease-out;
        }

        #successToast::after {
            content: "Check";
            font-size: 28px;
        }

        @keyframes toastPop {
            0%   { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
            60%  { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="menu-toggle" id="menu-toggle">Menu</div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><h2>CashFlow</h2></div>
    <div class="sidebar-menu">
        <div class="menu-item active" data-page="home">Home</div>
        <div class="menu-item" data-page="expenses">Expenses</div>
        <div class="menu-item" data-page="add-expense">Add Expense</div>
        <div class="menu-item" data-page="profile">Profile</div>
        <div class="menu-item" data-page="about">About</div>
    </div>
    <div class="logout-btn" onclick="logout()">Logout</div>
</div>

<div class="main">
    <div class="header">
        <h1>CashFlow Dashboard</h1>
        <div style="display:flex; align-items:center; gap:15px;">
            <div>Welcome, <strong id="username">User</strong>!</div>
            <div class="theme-toggle" id="theme-toggle">Moon</div>
        </div>
    </div>

    <div id="home" class="page">
        <div class="stats-grid">
            <div class="stat-card"><div class="card-title">Total Money (Budget)</div><div class="card-value" id="total-money">0</div></div>
            <div class="stat-card"><div class="card-title">Total Expenses</div><div class="card-value" id="total-expenses">0</div></div>
            <div class="stat-card"><div class="card-title">Remaining Money</div><div class="card-value" id="remaining-money">0</div></div>
            <div class="stat-card"><div class="card-title">This Month Spent</div><div class="card-value" id="monthly-spent">0</div></div>
        </div>

        <div class="charts-row">
            <div class="chart-box"><div class="chart-title">Expense Categories</div><canvas id="pieChart"></canvas></div>
            <div class="chart-box"><div class="chart-title">Monthly Expenses</div><canvas id="barChart"></canvas></div>
        </div>
        <div class="full-chart"><div class="chart-title">Balance Trend</div><canvas id="lineChart"></canvas></div>
    </div>

    <div id="expenses" class="page hidden">
        <h2 style="padding-buttom:10px">Your Expenses</h2>
        <div id="expenses-list"><p style="text-align:center; padding:40px; color:var(--text-light);">No expenses added yet.</p></div>
    </div>

    <div id="add-expense" class="page hidden">
        <h2>Add New Expense</h2>
        <div style="max-width:500px; margin:0 auto;">
            <div class="form-group"><label>Expense Name</label><input type="text" id="exp-name" placeholder="e.g. Food, Rent"></div>
            <div class="form-group"><label>Amount</label><input type="number" id="exp-amount" placeholder="0"></div>
            <div class="form-group"><label>Date</label><input type="date" id="exp-date"></div>
            <button class="btn" onclick="addExpense()">Add Expense</button>
        </div>
    </div>

    <div id="profile" class="page hidden">
        <h2>Profile & Settings</h2>
        <div style="max-width:500px; margin:0 auto;">
            <div class="form-group"><label>Name</label><input type="text" id="profile-name"></div>
            <div class="form-group"><label>Monthly Budget</label><input type="number" id="profile-budget" placeholder="e.g. 50000"></div>
            <div class="form-group"><label>Currency</label>
                <select id="profile-currency">
                    <option value="USD">$ USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="INR" selected>INR</option>
                </select>
            </div>
            <button class="btn" onclick="saveProfile()">Save Profile</button>
        </div>
    </div>

    <div id="about" class="page hidden">
        <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
            <h2 style="font-size: 32px; font-weight: 700; text-align: center; margin-bottom: 16px; color: var(--primary);">
                About CashFlow
            </h2>
            <p style="text-align: center; font-size: 18px; color: var(--text-light); margin-bottom: 40px; line-height: 1.7;">
                A simple, beautiful, and powerful personal finance tracker built for privacy and peace of mind.
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 50px;">
                <!-- Feature Card 1 -->
                <div style="background: var(--card-bg); padding: 28px; border-radius: 20px; box-shadow: 0 8px 25px var(--shadow); border: 1px solid var(--border); text-align: center; transition: transform 0.3s;">
                    <div style="width: 70px; height: 70px; background: rgba(67, 97, 238, 0.15); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        Chart
                    </div>
                    <h3 style="font-size: 20px; margin: 16px 0 12px; color: var(--text);">Smart Tracking</h3>
                    <p style="color: var(--text-light); line-height: 1.6;">Track expenses, set budgets, and visualize spending with beautiful interactive charts.</p>
                </div>

                <!-- Feature Card 2 -->
                <div style="background: var(--card-bg); padding: 28px; border-radius: 20px; box-shadow: 0 8px 25px var(--shadow); border: 1px solid var(--border); text-align: center; transition: transform 0.3s;">
                    <div style="width: 70px; height: 70px; background: rgba(16, 185, 129, 0.15); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        Shield
                    </div>
                    <h3 style="font-size: 20px; margin: 16px 0 12px; color: var(--text);">100% Private</h3>
                    <p style="color: var(--text-light); line-height: 1.6;">No accounts. No cloud sync. No tracking. Your data stays on your device — forever.</p>
                </div>


            </div>

            <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, rgba(67, 97, 238, 0.08), rgba(139, 92, 246, 0.08)); border-radius: 20px; border: 1px dashed var(--border);">
                <h3 style="font-size: 22px; margin-bottom: 16px; color: var(--text);">No ads. No subscriptions. No data collection.</h3>
                <p style="font-size: 18px; color: var(--primary); font-weight: 600;">
                    Just you and your money Forever.
                </p>
            </div>

            <div style="text-align: center; margin-top: 50px; color: var(--text-light); font-size: 15px;">
                <p>
                    Made with <span style="color: #e11d48;">Heart</span> by <strong>Harshvardhan Tiwari</strong><br>
                    Version 1.0 • 2025
                </p>
            </div>
        </div>
    </div>

    <!-- BEAUTIFUL CENTERED SUCCESS TOAST -->
    <div id="successToast">
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // SUCCESS TOAST FUNCTION
        function showSuccess(message = "Success!") {
            const toast = document.getElementById("successToast");
            const msg = document.getElementById("toastMessage");
            msg.textContent = message;
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 3000);
        }

        // UI: Menu & Theme
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        menuToggle.addEventListener('click', () => sidebar.classList.toggle('active'));

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                document.getElementById(item.dataset.page).classList.remove('hidden');
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                if (item.dataset.page === 'home') updateDashboard();
                if (item.dataset.page === 'expenses') loadExpenses();
                sidebar.classList.remove('active');
            });
        });

        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.innerHTML = savedTheme === 'dark' ? 'Sun' : 'Moon';
        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.innerHTML = newTheme === 'dark' ? 'Sun' : 'Moon';
        });

        // State
        let user = { name: "Loading...", budget: 0, currency: "INR", symbol: "₹" };
        let expenses = [];
        let pieChart = null, barChart = null, lineChart = null;
        const pieChartCanvas = document.getElementById('pieChart');
        const barChartCanvas = document.getElementById('barChart');
        const lineChartCanvas = document.getElementById('lineChart');
        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        function formatMoney(n) {
            return user.symbol + Number(n || 0).toLocaleString('en-IN');
        }

        // User
        async function loadUserData() {
            try {
                const res = await fetch('/api/auth/me', { credentials: 'include' });
                if (res.status === 401) { window.location.href = '/login.html'; return false; }
                if (!res.ok) return false;
                user = await res.json();
                document.getElementById('username').textContent = user.name ?? "User";
                document.getElementById('profile-name').value = user.name ?? "";
                document.getElementById('profile-budget').value = user.budget ?? "";
                document.getElementById('profile-currency').value = user.currency ?? "INR";
                user.symbol = user.currency === "USD" ? "$" : user.currency === "EUR" ? "€" : user.currency === "GBP" ? "£" : "₹";
                updateDashboard();
                return true;
            } catch (err) {
                window.location.href = '/login.html';
                return false;
            }
        }

        async function saveProfile() {
            const updatedData = {
                name: document.getElementById('profile-name').value.trim() || "User",
                budget: parseFloat(document.getElementById('profile-budget').value) || 0,
                currency: document.getElementById('profile-currency').value || "INR"
            };
            try {
                const res = await fetch('/api/auth/update', {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                if (res.ok) {
                    user = await res.json();
                    document.getElementById('username').textContent = user.name;
                    updateDashboard();
                    showSuccess("Profile updated"); // Success popup
                } else {
                    showSuccess("Update failed");
                }
            } catch (err) {
                showSuccess("Network error");
            }
        }

        // Expenses
        async function loadExpenses() {
            try {
                const res = await fetch('/api/expenses', { credentials: 'include' });
                if (res.status === 401) { window.location.href = '/login.html'; return; }
                expenses = await res.json().catch(() => []);
                renderExpenseList();
                updateDashboard();
            } catch (err) {
                expenses = [];
                renderExpenseList();
                updateDashboard();
            }
        }

        async function addExpense() {
            const title = document.getElementById('exp-name').value.trim();
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const date = document.getElementById('exp-date').value;

            if (!title || !amount || !date) {
                showSuccess("Please fill all fields");
                return;
            }

            try {
                const res = await fetch('/api/expenses', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, amount, date })
                });

                if (res.status === 401) { window.location.href = '/login.html'; return; }
                if (!res.ok) {
                    showSuccess("Failed to save expense");
                    return;
                }

                // Success!
                document.getElementById('exp-name').value = '';
                document.getElementById('exp-amount').value = '';
                document.getElementById('exp-date').value = '';
                await loadExpenses();
                showSuccess("Expense added successfully");
            } catch (err) {
                showSuccess("Network error");
            }
        }

        async function deleteExpense(id) {
            if (!confirm("Delete this expense?")) return;
            try {
                const res = await fetch(`/api/expenses/${id}`, { method: 'DELETE', credentials: 'include' });
                if (res.status === 401) { window.location.href = '/login.html'; return; }
                if (!res.ok) { showSuccess("Failed to delete"); return; }
                await loadExpenses();
                showSuccess("Expense deleted");
            } catch (err) {
                showSuccess("Network error");
            }
        }

        // Render
        function renderExpenseList() {
            const container = document.getElementById('expenses-list');
            if (!expenses || expenses.length === 0) {
                container.innerHTML = `<p style='text-align:center; padding:40px; color:var(--text-light);'>No expenses yet</p>`;
                return;
            }
            container.innerHTML = '';
            expenses.forEach(e => {
                const title = e.title ?? '(No title)';
                const d = e.date ?? '';
                const amount = Number(e.amount) || 0;
                const id = e.id ?? '';
                container.innerHTML += `
                    <div class="expense-item">
                        <div>
                            <h4 style="margin:0; color:var(--text);">${escapeHtml(title)}</h4>
                            <p style="margin:4px 0 0; color:var(--text-light);">${d} • ${formatMoney(amount)}</p>
                        </div>
                        <button class="btn-danger" onclick="deleteExpense(${id})">Delete</button>
                    </div>
                `;
            });
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"'`=\/]/g, s => '&#' + s.charCodeAt(0) + ';');
        }

        // Charts
        function updateDashboard() {
            const totalExp = expenses.reduce((s, e) => s + (Number(e.amount) || 0), 0);
            const budget = Number(user.budget) || 0;
            const remaining = Math.max(0, budget - totalExp);

            document.getElementById('total-money').textContent = formatMoney(budget);
            document.getElementById('total-expenses').textContent = formatMoney(totalExp);
            document.getElementById('remaining-money').textContent = formatMoney(remaining);
            document.getElementById('monthly-spent').textContent = formatMoney(totalExp);

            // Pie Chart
            const cat = expenses.reduce((a, e) => { const k = e.title ?? 'Other'; a[k] = (a[k] || 0) + Number(e.amount || 0); return a; }, {});
            const labels = Object.keys(cat);
            const data = Object.values(cat);
            if (pieChart) pieChart.destroy();
            if (pieChartCanvas) {
                pieChart = new Chart(pieChartCanvas, { type: 'doughnut', data: { labels: labels.length ? labels : ['No Data'], datasets: [{ data: data.length ? data : [1] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            }

            // Bar Chart
            const monthly = Array(12).fill(0);
            expenses.forEach(e => { try { const m = new Date(e.date).getMonth(); if (!isNaN(m)) monthly[m] += Number(e.amount) || 0; } catch(e){} });
            if (barChart) barChart.destroy();
            if (barChartCanvas) {
                barChart = new Chart(barChartCanvas, { type: 'bar', data: { labels: monthNames, datasets: [{ label: "Expenses", data: monthly }] }, options: { responsive: true, maintainAspectRatio: false } });
            }

            // Line Chart
            let bal = budget;
            const trend = [bal];
            for (let i = 0; i < 11; i++) { bal -= monthly[i]; trend.push(Math.max(0, bal)); }
            if (lineChart) lineChart.destroy();
            if (lineChartCanvas) {
                lineChart = new Chart(lineChartCanvas, { type: 'line', data: { labels: monthNames, datasets: [{ label: "Balance", data: trend, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } });
            }
        }

        // Logout
        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.href = '/landingpage.html';
        }

        // Init
        (async function init() {
            const ok = await loadUserData();
            if (ok) await loadExpenses();
        })();

        // Prevent back button
        window.history.pushState(null, "", window.location.href);
        window.onpopstate = () => window.history.pushState(null, "", window.location.href);
    </script>
</body>
</html>